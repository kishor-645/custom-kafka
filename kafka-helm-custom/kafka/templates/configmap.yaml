{{- /*
Kafka ConfigMap
*/ -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  namespace: {{ .Values.namespace }}
  labels:
    app: kafka
    release: {{ .Release.Name }}
data:
  # KRaft Settings
  KAFKA_CFG_PROCESS_ROLES: {{ .Values.kafka.processRoles | quote }}
  KAFKA_CFG_NODE_ID: "1"
  KAFKA_CFG_CLUSTER_ID: {{ .Values.kafka.clusterId | quote }}
  {{- $replicas := int .Values.kafka.replicas }}
  {{- $voters := list }}
  {{- if eq $replicas 1 }}
  {{- $voters = append $voters (printf "1@%s-0.%s-headless.%s.svc.cluster.local:9093" $.Release.Name $.Release.Name $.Values.namespace) }}
  {{- else }}
  {{- range $i := until $replicas }}
  {{- $nodeId := add1 $i }}
  {{- $voters = append $voters (printf "%d@%s-%d.%s-headless.%s.svc.cluster.local:9093" $nodeId $.Release.Name $i $.Release.Name $.Values.namespace) }}
  {{- end }}
  {{- end }}
  KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: {{ join "," $voters | quote }}
  
  # Listeners
  {{- if .Values.kafka.listeners.client.enabled }}
  KAFKA_CFG_LISTENERS: "PLAINTEXT://0.0.0.0:{{ .Values.kafka.listeners.client.port }},CONTROLLER://0.0.0.0:{{ .Values.kafka.listeners.controller.port }},INTERNAL://0.0.0.0:{{ .Values.kafka.listeners.internal.port }}"
  KAFKA_CFG_ADVERTISED_LISTENERS_TEMPLATE: "PLAINTEXT://%s.{{ .Release.Name }}-headless.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kafka.listeners.client.port }},CONTROLLER://%s.{{ .Release.Name }}-headless.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kafka.listeners.controller.port }},INTERNAL://%s.{{ .Release.Name }}-headless.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kafka.listeners.internal.port }}"
  KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT"
  {{- end }}
  
  KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
  KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "INTERNAL"
  
  # Replication
  KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: {{ .Values.kafka.replication.offsetsTopicReplicationFactor | quote }}
  KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: {{ .Values.kafka.replication.transactionLogReplicationFactor | quote }}
  KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: {{ .Values.kafka.replication.transactionLogMinIsr | quote }}
  KAFKA_CFG_MIN_INSYNC_REPLICAS: {{ .Values.kafka.replication.minInSyncReplicas | quote }}
  KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: {{ .Values.kafka.replication.defaultReplicationFactor | quote }}
  
  # Storage
  KAFKA_CFG_LOG_DIRS: {{ .Values.kafka.storage.mountPath }}
  KAFKA_CFG_LOG_RETENTION_HOURS: {{ .Values.kafka.storage.logs.retentionHours | quote }}
  {{- if .Values.kafka.storage.logs.retentionBytes }}
  KAFKA_CFG_LOG_RETENTION_BYTES: {{ .Values.kafka.storage.logs.retentionBytes | quote }}
  {{- end }}
  KAFKA_CFG_LOG_SEGMENT_BYTES: {{ .Values.kafka.storage.logs.segmentBytes | quote }}
  
  # Performance
  KAFKA_CFG_NUM_NETWORK_THREADS: {{ .Values.kafka.performance.networkThreads | quote }}
  KAFKA_CFG_NUM_IO_THREADS: {{ .Values.kafka.performance.ioThreads | quote }}
  KAFKA_CFG_SOCKET_SEND_BUFFER_BYTES: {{ .Values.kafka.performance.socketSendBufferBytes | quote }}
  KAFKA_CFG_SOCKET_RECEIVE_BUFFER_BYTES: {{ .Values.kafka.performance.socketReceiveBufferBytes | quote }}
  KAFKA_CFG_SOCKET_REQUEST_MAX_BYTES: {{ .Values.kafka.performance.socketRequestMaxBytes | quote }}
  KAFKA_CFG_BATCH_SIZE: {{ .Values.kafka.performance.batchSize | quote }}
  KAFKA_CFG_LINGER_MS: {{ .Values.kafka.performance.lingerMs | quote }}
  
  # Compression
  KAFKA_CFG_COMPRESSION_TYPE: "snappy"
  KAFKA_CFG_NUM_PARTITIONS: "3"
